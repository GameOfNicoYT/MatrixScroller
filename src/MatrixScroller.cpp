// src/MatrixScroller.cpp
#include "MatrixScroller.h"

#if defined(ARDUINO_ARCH_AVR)
  #include <avr/pgmspace.h>
  #define PROGMEM_LIKE PROGMEM
  #define READ_FONT(p) pgm_read_byte(p)
#else
  #define PROGMEM_LIKE
  #define READ_FONT(p) (*(const uint8_t*)(p))
#endif

static const uint8_t FONT5x7[][5] PROGMEM_LIKE = {
  {0,0,0,0,0},{0,0,0x5F,0,0},{0,7,0,7,0},{0x14,0x7F,0x14,0x7F,0x14},
  {0x24,0x2A,0x7F,0x2A,0x12},{0x23,0x13,8,0x64,0x62},{0x36,0x49,0x55,0x22,0x50},{0,5,3,0,0},
  {0,0x1C,0x22,0x41,0},{0,0x41,0x22,0x1C,0},{0x14,8,0x3E,8,0x14},{8,8,0x3E,8,8},
  {0,0x50,0x30,0,0},{8,8,8,8,8},{0,0x60,0x60,0,0},{0x20,0x10,8,4,2},
  {0x3E,0x51,0x49,0x45,0x3E},{0,0x42,0x7F,0x40,0},{0x42,0x61,0x51,0x49,0x46},{0x21,0x41,0x45,0x4B,0x31},
  {0x18,0x14,0x12,0x7F,0x10},{0x27,0x45,0x45,0x45,0x39},{0x3C,0x4A,0x49,0x49,0x30},{1,0x71,9,5,3},
  {0x36,0x49,0x49,0x49,0x36},{6,0x49,0x49,0x29,0x1E},{0,0x36,0x36,0,0},{0,0x56,0x36,0,0},
  {8,0x14,0x22,0x41,0},{0x14,0x14,0x14,0x14,0x14},{0,0x41,0x22,0x14,8},{2,1,0x51,9,6},
  {0x3E,0x41,0x5D,0x55,0x1E},{0x7E,0x11,0x11,0x11,0x7E},{0x7F,0x49,0x49,0x49,0x36},{0x3E,0x41,0x41,0x41,0x22},
  {0x7F,0x41,0x41,0x22,0x1C},{0x7F,0x49,0x49,0x49,0x41},{0x7F,9,9,9,1},{0x3E,0x41,0x49,0x49,0x7A},
  {0x7F,8,8,8,0x7F},{0,0x41,0x7F,0x41,0},{0x20,0x40,0x41,0x3F,1},{0x7F,0x08,0x14,0x22,0x41},
  {0x7F,0x40,0x40,0x40,0x40},{0x7F,2,0x0C,2,0x7F},{0x7F,4,8,0x10,0x7F},{0x3E,0x41,0x41,0x41,0x3E},
  {0x7F,9,9,9,6},{0x3E,0x41,0x51,0x21,0x5E},{0x7F,9,0x19,0x29,0x46},{0x46,0x49,0x49,0x49,0x31},
  {1,1,0x7F,1,1},{0x3F,0x40,0x40,0x40,0x3F},{0x1F,0x20,0x40,0x20,0x1F},{0x7F,0x20,0x18,0x20,0x7F},
  {0x63,0x14,8,0x14,0x63},{7,8,0x70,8,7},{0x61,0x51,0x49,0x45,0x43},{0,0x7F,0x41,0x41,0},
  {2,4,8,0x10,0x20},{0,0x41,0x41,0x7F,0},{4,2,1,2,4},{0,0,0,0,0x00}
};

MatrixScroller::MatrixScroller(ArduinoLEDMatrix& m)
: mx(m), interval(60), lastTick(0), off(-12), text(),
  repeatTarget(0), repeatCount(0), finished(false) {}

void MatrixScroller::begin(uint16_t interval_ms){ interval = interval_ms; lastTick = 0; reset(); }
void MatrixScroller::setText(const String& s){ text = s; reset(); }
void MatrixScroller::setSpeed(uint16_t interval_ms){ interval = interval_ms; }
void MatrixScroller::setRepeat(uint32_t times){ repeatTarget = times; repeatCount = 0; finished = false; }
void MatrixScroller::reset(){ off = -12; repeatCount = 0; finished = false; }
bool MatrixScroller::isFinished() const { return finished; }

const uint8_t* MatrixScroller::glyph(char c){
  uint8_t idx = (c < 0x20 || c > 0x7E) ? 0 : uint8_t(c - 0x20);
  return &FONT5x7[idx][0];
}

void MatrixScroller::drawWindow(uint8_t frame[8][12], const String& s, int32_t xoff){
  memset(frame, 0, 8*12);
  const int32_t totalCols = int32_t(s.length()) * 6; // 5 Spalten + 1 Spacer
  for(int col=0; col<12; ++col){
    const int32_t srcCol = xoff + col;
    if(srcCol < 0 || srcCol >= totalCols) continue;
    const int chIndex = srcCol / 6;
    const int inCharCol = srcCol % 6;
    uint8_t colBits = 0;
    if(inCharCol < 5){
      const uint8_t* g = glyph(s[chIndex]);
      colBits = READ_FONT(g + inCharCol);
    }
    for(int row=0; row<7; ++row){
      frame[row][col] = (colBits >> row) & 0x01;
    }
  }
}

void MatrixScroller::update(){
  if(finished) return;

  const uint32_t now = millis();
  if(now - lastTick < interval) return;
  lastTick = now;

  uint8_t frame[8][12];
  drawWindow(frame, text, off);
  mx.loadPixels(&frame[0][0], 8*12);

  off++;

  const int32_t totalCols = int32_t(text.length()) * 6;
  if(off > totalCols){
    off = -12;                     // neuer Durchlauf
    repeatCount++;
    if(repeatTarget > 0 && repeatCount >= repeatTarget){
      finished = true;             // stoppt weiteres Scrolling
    }
  }
}
